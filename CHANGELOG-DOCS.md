# –°–≤–æ–¥–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

## üéâ –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ idempotency_key (19 –Ω–æ—è–±—Ä—è 2025)

### ‚úÖ –ì–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: idempotency_key –∫–∞–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ

**–ë—ã–ª–æ (–Ω–µ—è–≤–Ω–æ –≤ metadata):**
```json
{
  "metadata": {
    "idempotency_key": "unique-123"  // ‚ùå –°–ø—Ä—è—Ç–∞–Ω–æ
  }
}
```

**–°—Ç–∞–ª–æ (—è–≤–Ω–æ–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ):**
```json
{
  "idempotency_key": "unique-123",  // ‚úÖ –Ø–≤–Ω–æ!
  "metadata": {
    "correlation_id": "trace-456"   // –¢–æ–ª—å–∫–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ
  }
}
```

**–ü–æ—á–µ–º—É:**
- ‚úÖ –Ø–≤–Ω–æ—Å—Ç—å –ª—É—á—à–µ –Ω–µ—è–≤–Ω–æ—Å—Ç–∏
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–±—ã—Ç—å –¥–æ–±–∞–≤–∏—Ç—å
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: `WHERE idempotency_key = $1` (–Ω–µ —á–µ—Ä–µ–∑ JSONB)
- ‚úÖ –í–∏–¥–Ω–æ –≤ Avro —Å—Ö–µ–º–∞—Ö

---

### 1. **–ö–†–ò–¢–ò–ß–ù–û: Avro Enum Symbols - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ 07-ARCHITECTURE-SPECS.md –ø—Ä–∏–º–µ—Ä—ã Avro —Å—Ö–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ dot-notation –≤ enum symbols (–Ω–∞–ø—Ä–∏–º–µ—Ä: `"v1.bets.bet.placed"`), —á—Ç–æ **–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ –≤ Avro** - enum symbols –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å `[A-Za-z_][A-Za-z0-9_]*`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –í—Å–µ –ø—Ä–∏–º–µ—Ä—ã Avro —Å—Ö–µ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ `UPPER_SNAKE_CASE`
- ‚úÖ –°—Ö–µ–º—ã –≤ `/infra/schemas/*.avsc` —É–∂–µ –±—ã–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:
  - `event_type` (enum) ‚Üí `"V1_PAYMENTS_DEPOSIT_COMPLETED"` (UPPER_SNAKE_CASE)
  - `event_name` (string) ‚Üí `"v1.payments.deposit.completed"` (dot-notation –¥–ª—è human-readable)
  - `tenant_id` ‚Üí `long` (–Ω–µ string)

**–§–∞–π–ª—ã:**
- `docs/07-ARCHITECTURE-SPECS.md` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã Avro —Å—Ö–µ–º

---

### 2. **–ö–†–ò–¢–ò–ß–ù–û: idempotency_key –≤ Materialized Views**

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `idempotency_key` –≤ materialized views, –Ω–æ –≤ V2 –º–∏–≥—Ä–∞—Ü–∏–∏ `idempotency_key` –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ü–∏–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `V3__add_idempotency_to_views.sql`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `idempotency_key` –≤:
  - `bets_view`
  - `payments_view`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ idempotency:
  ```sql
  CREATE INDEX idx_bets_view_idempotency 
  ON bets_view(tenant_id, idempotency_key) 
  WHERE idempotency_key IS NOT NULL;
  ```
- ‚úÖ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ **–±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å idempotency –∏–∑ views**, –Ω–µ –æ–±—Ä–∞—â–∞—è—Å—å –∫ event tables
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ 09:
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ idempotency —Ç–µ–ø–µ—Ä—å –∏–∑ `payments_view` (–Ω–µ –∏–∑ `payment_events`)
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ —Å `bet_id` vs `aggregate_id`
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ event tables —Ç–æ–ª—å–∫–æ –¥–ª—è audit/debug

**–§–∞–π–ª—ã:**
- `infra/migrations/V3__add_idempotency_to_views.sql` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
- `docs/09-DATABASE-QUERIES.md` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã —Å idempotency

---

### 3. **–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ 09 –±—ã–ª–∏ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä—è–º–æ–≥–æ —á—Ç–µ–Ω–∏—è –∏–∑ event tables –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –ü–æ–º–µ—á–µ–Ω—ã —Ä–∞–∑–¥–µ–ª—ã "–ß—Ç–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π" –∫–∞–∫ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ **—Ç–æ–ª—å–∫–æ –¥–ª—è audit/debugging**
- ‚úÖ –ü–æ–º–µ—á–µ–Ω —Ä–∞–∑–¥–µ–ª "–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ü–∏–∏" –∫–∞–∫ **—É—Å—Ç–∞—Ä–µ–≤—à–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —á—Ç–µ–Ω–∏—è –∏–∑ `bets_view`
- ‚úÖ –í—Å–µ –ø—Ä–∏–º–µ—Ä—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è—é—Ç idempotency —á–µ—Ä–µ–∑ views

**–§–∞–π–ª—ã:**
- `docs/09-DATABASE-QUERIES.md` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

---

### 3. **–î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –ù–ï–¢

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ú–∏–≥—Ä–∞—Ü–∏—è `V1__initial_schema.sql` —Å—Ç—Ä–æ–∫–∏ 32-34:
  ```sql
  INSERT INTO tenants (id, name, slug, status, plan)
  VALUES (10001, 'Default Tenant', 'default', 'active', 'basic')
  ON CONFLICT (id) DO NOTHING;
  ```
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è `02-QUICKSTART.md` —Å—Ç—Ä–æ–∫–∞ 12: "–°–æ–∑–¥–∞–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç (ID: 10001)"

**–í—ã–≤–æ–¥:** –í—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ.

---

### 4. **–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è materialized views**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–∞–ø–∞–∑–æ–Ω `~100-300ms` –≤–æ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –≤–º–µ—Å—Ç–æ —Ç–æ—á–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è, —Ç.–∫.:
- –í—Ä–µ–º—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏
- `bets_view` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ (~100ms)
- `tenants_summary_view` –º–µ–¥–ª–µ–Ω–Ω–µ–µ (~300ms –ø—Ä–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è—Ö)

**–§–∞–π–ª—ã:**
- `docs/10-MATERIALIZED-VIEWS.md` - –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω ~100-300ms
- `docs/09-DATABASE-QUERIES.md` - –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω
- `docs/12-ARCHITECTURE-DECISIONS.md` - –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω

---

## üìã –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Event Naming Convention (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è):

```typescript
{
  "event_type": "V1_PAYMENTS_DEPOSIT_COMPLETED",  // enum: UPPER_SNAKE_CASE (–¥–ª—è Avro)
  "event_name": "v1.payments.deposit.completed",  // string: dot-notation (human-readable)
  "tenant_id": 10001,  // long (numeric)
  "aggregate_id": "payment-123",  // string (UUID –∏–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å+UUID)
  "metadata": {
    "idempotency_key": "unique-key-12345"  // –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  }
}
```

### Idempotency Pattern (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è):

```typescript
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ idempotency –∏–∑ materialized view (–ë–´–°–¢–†–û!)
const existing = await pool.query(`
  SELECT bet_id FROM bets_view 
  WHERE tenant_id = $1 
    AND idempotency_key = $2
  LIMIT 1
`, [tenantId, idempotencyKey]);

if (existing.rows.length > 0) {
  // –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ - –≤–µ—Ä–Ω—É—Ç—å –∏–∑ view
  return existing.rows[0];
}

// INSERT —Å–æ–±—ã—Ç–∏—è...
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (indexed materialized view)
- ‚úÖ –ù–µ —á–∏—Ç–∞–µ–º event tables –Ω–∞–ø—Ä—è–º—É—é
- ‚úÖ –°–æ–±–ª—é–¥–∞–µ–º CQRS –ø—Ä–∏–Ω—Ü–∏–ø (Command —á–µ—Ä–µ–∑ events, Query —á–µ—Ä–µ–∑ views)

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ):

1. **Event Tables:**
   - ‚úÖ **–¢–û–õ–¨–ö–û INSERT** - –Ω–∏–∫–∞–∫–∏—Ö UPDATE/DELETE
   - ‚ùå **–ù–ï –ß–ò–¢–ê–¢–¨** –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è audit/debug)
   - ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è:** audit log, time travel, event replay

2. **Materialized Views:**
   - ‚úÖ **–¢–û–õ–¨–ö–û SELECT** - –¥–ª—è –≤—Å–µ—Ö —á—Ç–µ–Ω–∏–π
   - ‚úÖ **–°–æ–¥–µ—Ä–∂–∞—Ç:** —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ + idempotency_key
   - ‚úÖ **–û–±–Ω–æ–≤–ª—è—é—Ç—Å—è:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã (~100-300ms)

3. **Idempotency:**
   - ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è—Ç—å:** –≤ materialized views (–±—ã—Å—Ç—Ä–æ)
   - ‚úÖ **–•—Ä–∞–Ω–∏—Ç—å:** –≤ metadata JSONB –ø–æ–ª–µ event tables
   - ‚úÖ **–ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å:** partial index –≤ views

4. **Avro Schemas:**
   - ‚úÖ **event_type:** enum —Å UPPER_SNAKE_CASE —Å–∏–º–≤–æ–ª–∞–º–∏
   - ‚úÖ **event_name:** string —Å dot-notation (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - ‚úÖ **tenant_id:** long (numeric), –Ω–µ string
   - ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤:** —Ç–æ–ª—å–∫–æ –í –ö–û–ù–ï–¶ —Å–ø–∏—Å–∫–∞

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é V3:**
   ```bash
   make tilt-up  # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ views —Å–æ–¥–µ—Ä–∂–∞—Ç idempotency_key:**
   ```sql
   SELECT tenant_id, bet_id, idempotency_key 
   FROM bets_view 
   WHERE tenant_id = 10001 LIMIT 5;
   ```

3. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ —Å–µ—Ä–≤–∏—Å–æ–≤** (–µ—Å–ª–∏ —É–∂–µ –Ω–∞–ø–∏—Å–∞–Ω—ã):
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å idempotency —á–µ—Ä–µ–∑ views
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `V1_PAYMENTS_*` –≤–º–µ—Å—Ç–æ `v1.payments.*` –¥–ª—è event_type

---

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-11-19  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 1.1  
**–°—Ç–∞—Ç—É—Å:** Production-ready
