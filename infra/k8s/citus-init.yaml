apiVersion: batch/v1
kind: Job
metadata:
  name: citus-init
  namespace: dev-infra
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: citus-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: postgres:18
          env:
            - name: PGUSER
              value: "app"
            - name: PGPASSWORD
              value: "app"
            - name: PGHOST
              value: "citus-coordinator"
            - name: PGDATABASE
              value: "app"
          command: ["bash","-lc"]
          args:
            - |
              echo "Waiting for coordinator...";
              for i in $(seq 1 60); do
                if pg_isready -U "$PGUSER" -d "$PGDATABASE" -h "$PGHOST" >/dev/null 2>&1; then echo ready; break; fi; sleep 2; done;
              echo "Creating Citus extension...";
              psql -v ON_ERROR_STOP=1 -c "CREATE EXTENSION IF NOT EXISTS citus;";
              echo "Registering worker...";
              psql -v ON_ERROR_STOP=1 -c "SELECT master_add_node('citus-worker-0.citus-worker.dev-infra.svc.cluster.local', 5432);" || true;
              echo "Citus initialization completed";
