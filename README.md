[üá∑üá∫ –†—É—Å—Å–∫–∏–π](README.md) | [üá¨üáß English](README.en.md)

---

# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

> –ï–¥–∏–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- make, bash, curl, jq, kubectl
- –õ–æ–∫–∞–ª—å–Ω—ã–π Kubernetes –∫–ª–∞—Å—Ç–µ—Ä (Docker Desktop Kubernetes, kind, –∏–ª–∏ minikube)
- Docker (–¥–ª—è –æ–±—Ä–∞–∑–æ–≤ –∏ k8s)

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ (—á–∏—Ç–∞—Ç—å –ø–æ –ø–æ—Ä—è–¥–∫—É!)
1. **[–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã](docs/01-SETUP-INFRASTRUCTURE.md)** - –ü–æ–¥–Ω–∏–º–∞–µ–º Tilt + Kubernetes (–ü–ï–†–í–´–ô –®–ê–ì!)
2. **[–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](docs/02-QUICKSTART.md)** - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–∏—Å–∞–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- **[03. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è](docs/03-ENVIRONMENT-VARS.md)** - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ
- **[04. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ Tiltfile](docs/04-TILTFILE-GUIDE.md)** - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Tilt –¥–ª—è –≤–∞—à–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- **[05. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º](docs/05-SERVICES-GUIDE.md)** - –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤

### Production
- **[06. Production Deployment](docs/06-PRODUCTION-DEPLOYMENT.md)** - CI/CD –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –¥–µ–ø–ª–æ–π

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **[07. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](docs/07-ARCHITECTURE-SPECS.md)** - Event sourcing, Kafka, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–î
- **[08. –ü–ª–∞–Ω –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã](docs/08-INFRA-PLAN.md)** - –ü–ª–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤)

‚ö†Ô∏è **–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –ø–æ—Ä—è–¥–∫—É:**

1. **[01. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã](docs/01-SETUP-INFRASTRUCTURE.md)** - –ö–∞–∫ –ø–æ–¥–Ω—è—Ç—å Tilt + Kubernetes (—á–∏—Ç–∞—Ç—å –ü–ï–†–í–´–ú!)
2. **[02. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](docs/02-QUICKSTART.md)** - –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–∏—Å–∞–º –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞

```bash
# 1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
cp infra/.env.sample infra/.env

# 2. –ü–æ–¥–Ω–∏–º–∏—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (Tilt —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
make tilt-up

# 3. –î–æ–∂–¥–∏—Ç–µ—Å—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
make infra-wait

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
make infra-test

# 5. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ Avro-—Å—Ö–µ–º—ã
make register-schemas
```

**–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
- `make integration` - –ø–æ–ª–Ω—ã–π one-shot –ø—Ä–æ–≥–æ–Ω (–ø–æ–¥–Ω—è—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)
- `make tilt-down` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ Tilt
- `make infra-down` - –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

üí° **MacOS + OrbStack:** –ï—Å–ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω OrbStack —Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–º K8S, –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `make tilt-up`

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: –ü–æ—Ä—Ç—ã –∏ —Å–µ—Ä–≤–∏—Å—ã

- Postgres/Citus (coordinator): localhost:5432
- Schema Registry: http://localhost:8081
- Redis: localhost:6379
- Redpanda (Kafka):
  - Broker: localhost:19092
  - Admin API: localhost:9644

–ü—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç Tilt (—Å–º. infra/Tiltfile). –í k8s —Ä–µ—Å—É—Ä—Å—ã —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –≤ namespace `dev-infra`.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

- –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è: `infra/.env` (—Å–æ–∑–¥–∞–π—Ç–µ –∏–∑ `infra/.env.sample`)
- –ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
  - `DATABASE_URL=postgresql://app:app@localhost:5432/app` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL/Citus
  - `REDIS_URL=redis://localhost:6379` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
  - `KAFKA_BROKERS=localhost:19092` - Kafka broker
  - `SCHEMA_REGISTRY_URL=http://localhost:8081` - Schema Registry
  - `LOKI_URL=http://localhost:3100` - Loki –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
  - `TOPIC_*` - –∏–º–µ–Ω–∞ Kafka —Ç–æ–ø–∏–∫–æ–≤ (V1_BETS, V1_PAYMENTS, etc.)
  - `K8S_NAMESPACE=dev-infra` - namespace –≤ Kubernetes

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:
- –î–ª—è k8s –∑–Ω–∞—á–µ–Ω–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ `infra/k8s/*.yaml` –∏ –ø—Ä–æ–±—Ä–æ—Å–æ–≤ Tilt
- –î–ª—è –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ Docker Compose: `USE_DOCKER=1 make infra-up`

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Postgres/Citus)

- **Connection String:** `DATABASE_URL=postgresql://app:app@localhost:5432/app`
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ psql:
  ```bash
  psql "postgresql://app:app@localhost:5432/app"
  # –∏–ª–∏ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  psql $DATABASE_URL
  ```

- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–¥–µ:
  ```javascript
  // Node.js
  const { Pool } = require('pg');
  const pool = new Pool({ connectionString: process.env.DATABASE_URL });
  ```
  ```php
  // PHP
  $dsn = getenv('DATABASE_URL');
  $pdo = new PDO($dsn);
  ```
  ```python
  # Python
  import os
  import psycopg2
  conn = psycopg2.connect(os.environ['DATABASE_URL'])
  ```

### –¢–µ–Ω–∞–Ω—Ç—ã –≤ Citus

- –°–∏–¥ —Å–æ–∑–¥–∞—ë—Ç —Ç–µ–Ω–∞–Ω—Ç–∞ 10001. –¢–∞–±–ª–∏—Ü–∞ `tenants(id bigint primary key, created_at timestamptz)` —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø–æ `id` –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Job.
- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞:
  ```sql
  INSERT INTO tenants(id) VALUES (10002);
  ```

- –†–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å ¬´—Ç–µ–Ω–∞–Ω—Ç—Å–∫–∏–µ¬ª —Ç–∞–±–ª–∏—Ü—ã –ø–æ `tenant_id` –∏ –∫–æ–ª–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å `tenants`:
  ```sql
  SELECT create_distributed_table('your_table', 'tenant_id', colocate_with => 'tenants');
  ```

- –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–Ω–∞–Ω—Ç–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –≤–æ—Ä–∫–µ—Ä–µ:
  1) –£–∑–Ω–∞—Ç—å shard id: 
     ```sql
     SELECT citus_get_shard_id_for_distribution_column('tenants'::regclass, 10002);
     ```
  2) –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —à–∞—Ä–¥: 
     ```sql
     SELECT citus_move_shard_placement(<shard_id>, old_node, old_port, 
       'citus-worker-0.citus-worker.dev-infra.svc.cluster.local', 5432);
     ```
  
  –í dev —Å—Ä–µ–¥–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–æ—Ä–∫–µ—Ä, –ø–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ–±—ã—á–Ω–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

## Redis

- **Connection String:** `REDIS_URL=redis://localhost:6379`
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  ```javascript
  // Node.js (ioredis)
  const Redis = require('ioredis');
  const redis = new Redis(process.env.REDIS_URL);
  ```
  ```python
  # Python
  import os
  import redis
  r = redis.from_url(os.environ['REDIS_URL'])
  ```
  ```php
  // PHP
  $redis = new Redis();
  $redis->connect(parse_url(getenv('REDIS_URL'), PHP_URL_HOST), 6379);
  ```

## Redpanda (Kafka)

- **Brokers:** `KAFKA_BROKERS=localhost:19092`
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  ```javascript
  // Node.js (KafkaJS)
  const { Kafka } = require('kafkajs');
  const kafka = new Kafka({
    brokers: process.env.KAFKA_BROKERS.split(',')
  });
  ```
  ```python
  # Python (kafka-python)
  from kafka import KafkaProducer
  import os
  producer = KafkaProducer(bootstrap_servers=os.environ['KAFKA_BROKERS'].split(','))
  ```
  ```go
  // Go (sarama)
  brokers := strings.Split(os.Getenv("KAFKA_BROKERS"), ",")
  config := sarama.NewConfig()
  producer, _ := sarama.NewSyncProducer(brokers, config)
  ```

- CLI —É—Ç–∏–ª–∏—Ç–∞ rpk:
  ```bash
  rpk cluster info --brokers $KAFKA_BROKERS
  rpk topic create V1_SYSTEM -p 1 -r 1 --brokers $KAFKA_BROKERS
  echo 'hello' | rpk topic produce V1_SYSTEM --brokers $KAFKA_BROKERS
  rpk topic consume V1_SYSTEM -n 1 --brokers $KAFKA_BROKERS
  ```

## Schema Registry

- **URL:** `SCHEMA_REGISTRY_URL=http://localhost:8081`
- –ü—Ä–æ–≤–µ—Ä–∫–∞:
  ```bash
  curl -fsS $SCHEMA_REGISTRY_URL/subjects
  ```
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—Ö–µ–º: `make register-schemas` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç TopicNameStrategy –∏ —Å—Ç–∞–≤–∏—Ç BACKWARD_TRANSITIVE –Ω–∞ Subject)
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  ```javascript
  // Node.js (@kafkajs/confluent-schema-registry)
  const { SchemaRegistry } = require('@kafkajs/confluent-schema-registry');
  const registry = new SchemaRegistry({ 
    host: process.env.SCHEMA_REGISTRY_URL 
  });
  ```
  ```python
  # Python (confluent-kafka)
  from confluent_kafka.schema_registry import SchemaRegistryClient
  import os
  sr = SchemaRegistryClient({'url': os.environ['SCHEMA_REGISTRY_URL']})
  ```

## Kafka —Ç–æ–ø–∏–∫–∏ –∏ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ

- –¢–æ–ø–∏–∫–∏ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º: V1_BETS, V1_PAYMENTS, V1_BALANCES, V1_COMPLIANCE, V1_SYSTEM
- –°—É–±–∂–µ–∫—Ç—ã SR: TopicNameStrategy ‚Üí {topic}-value
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å SR: BACKWARD_TRANSITIVE
- –ö–ª—é—á —Å–æ–æ–±—â–µ–Ω–∏—è Kafka: aggregate_id; —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏: tenant_id (numeric, e.g. 10001), version
- –ü–æ–ª—è —Å–æ–±—ã—Ç–∏–π:
  - TIER1 (bets/payments/balances/compliance): `event_type` (enum UPPER_SNAKE_CASE)
  - system_events: `event_type` (string, UPPER_SNAKE_CASE)

## –î–µ–Ω–µ–∂–Ω—ã–µ —Å—É–º–º—ã

- –í—Å–µ–≥–¥–∞ —Ü–µ–ª—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ ¬´—Ü–µ–Ω—Ç–∞—Ö¬ª (Avro long). –ù–∏–∫–∞–∫–∏—Ö float/double –¥–ª—è –¥–µ–Ω–µ–≥.

## –ö–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

- `make tilt-up`: –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É —á–µ—Ä–µ–∑ Tilt (–∞–≤—Ç–æ‚Äë—É—Å—Ç–∞–Ω–æ–≤–∫–∞ Tilt)
- `make infra-wait`: –¥–æ–∂–¥–∞—Ç—å—Å—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (k8s‚Äëaware)
- `make infra-test`: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (–∞–≤—Ç–æ-—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å—Ö–µ–º—ã –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º)
- `make register-schemas`: –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å Avro —Å—Ö–µ–º—ã –∏ –∑–∞–¥–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
- `make integration`: –ø–æ–¥–Ω—è—Ç—å —á–µ—Ä–µ–∑ Tilt (CI‚Äë—Ä–µ–∂–∏–º) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç—ã
- `make tilt-down`: –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Tilt
- `make infra-down`: —É–¥–∞–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∏ namespace

## Observability (Dev/Stage)

- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å `make tilt-up` (Loki, Promtail, Grafana –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ infra/Tiltfile).
- –†—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞/—Å–Ω–æ—Å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±–µ–∑ Tilt):
  ```bash
  make obs-up
  make obs-down
  ```

- Grafana:
  ```bash
  kubectl -n dev-infra port-forward svc/grafana 3000:3000
  ```
  –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000 (admin/admin). Datasource Loki —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.

- Promtail —Å–æ–±–∏—Ä–∞–µ—Ç stdout –≤—Å–µ—Ö pod'–æ–≤; —Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ labels (namespace=dev-infra, app=<service>).

- –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ UI Grafana –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —á–µ—Ä–µ–∑ Tilt —É–∂–µ –µ—Å—Ç—å port‚Äëforward 3000 ‚Üí 3000.

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Loki)

- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**: –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –ø–∏—à—É—Ç –ª–æ–≥–∏ –≤ stdout; Promtail (DaemonSet) –ø–æ–¥–±–∏—Ä–∞–µ—Ç –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ Loki.
  - –ê–≤—Ç–æ–ª–µ–π–±–ª—ã: `namespace`, `pod`, `app`, `container`, `node` (—Å–º. promtail relabel_configs).
  - –í dev –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω—ã–π Loki; –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö/–∏–Ω—Ñ—Ä–∞‚Äë–ª–æ–≥–æ–≤ Promtail —à–ª—ë—Ç –≤ tenant 10001.

- **Direct push (–ø–µ—Ä‚Äë–∑–∞–ø—Ä–æ—Å–Ω–∞—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å, –≤–∞—Ä–∏–∞–Ω—Ç B)**: –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã —Å–∞–º–∏ –ø—É—à–∞—Ç –ª–æ–≥–∏ –≤ Loki –∏ –ø—Ä–æ—Å—Ç–∞–≤–ª—è—é—Ç tenant –∏–∑ –≤—Ö–æ–¥—è—â–µ–≥–æ HTTP‚Äë–∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞.
  - –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –±–µ—Ä–∏—Ç–µ tenant –∏–∑ env ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
  - –ö–∞–∫–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫? –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º `X-Tenant-Id: <numeric>`; –¥–∞–ª–µ–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è `X-Scope-OrgID` –ø—Ä–∏ –ø—É—à–µ –≤ Loki.
  - –≠–Ω–¥–ø–æ–∏–Ω—Ç –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ: `http://loki:3100/loki/api/v1/push`.
  - –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –≤–Ω–µ –∫–ª–∞—Å—Ç–µ—Ä–∞:
    - –ü–æ—Ä—Ç‚Äë—Ñ–æ—Ä–≤–∞—Ä–¥: `kubectl -n dev-infra port-forward svc/loki 3100:3100`
    - –í `.env`: `LOKI_URL=http://localhost:3100`
  - –ü—Ä–∏–º–µ—Ä curl:
    ```bash
    ts_ns=$(( $(date +%s) * 1000000000 ))
    json='{"streams":[{"stream":{"service":"my-api","env":"dev"},"values":[["'"$ts_ns"'","hello from my-api"]]}]}'
    curl -s -o /dev/null -w "%{http_code}\n" \
      -H 'Content-Type: application/json' \
      -H "X-Scope-OrgID: ${TENANT_ID_FROM_REQUEST}" \
      -X POST --data "$json" "$LOKI_URL/loki/api/v1/push"
    # –û–∂–∏–¥–∞–µ–º—ã–π –∫–æ–¥: 204
    ```
  - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ª–µ–π–±–ª—ã –≤ stream: `service`, `env`, `version`.
  - –ù–µ –ª–æ–≥–∏—Ä—É–π—Ç–µ tenant –≤ –ª–µ–π–±–ª–∞—Ö/—Ç–µ–ª–µ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏; –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `X-Scope-OrgID`.

- Grafana:
  - Explore ‚Üí Datasource Loki (–Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å `X-Scope-OrgID: 10001` –¥–ª—è dev‚Äë–æ–±–∑–æ—Ä–∞ –∏–Ω—Ñ—Ä–∞‚Äë–ª–æ–≥–æ–≤).
  - –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤: `{service="my-api"}`, `{namespace="dev-infra"}`.

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã (Direct push)

**Node.js (Express)**
```js
import fetch from 'node-fetch';

const LOKI_URL = process.env.LOKI_URL || 'http://loki:3100';

export async function logToLoki(req, message, labels = {}) {
  const tenant = req.get('X-Tenant-Id'); // numeric, required
  if (!tenant) return; // or 400/skip
  const tsNs = BigInt(Date.now()) * 1000000n;
  const stream = { 
    stream: { service: 'my-api', env: 'dev', ...labels }, 
    values: [[tsNs.toString(), message]] 
  };
  await fetch(`${LOKI_URL}/loki/api/v1/push`, {
    method: 'POST',
    headers: { 
      'content-type': 'application/json', 
      'X-Scope-OrgID': tenant 
    },
    body: JSON.stringify({ streams: [stream] }),
  });
}
```

**Go (net/http)**
```go
tenant := r.Header.Get("X-Tenant-Id")
if tenant != "" {
  ts := time.Now().UnixNano()
  body := fmt.Sprintf(`{"streams":[{"stream":{"service":"my-api","env":"dev"},"values":[["%d","%s"]]}]}`,
    ts, "hello from go")
  req, _ := http.NewRequest("POST", os.Getenv("LOKI_URL")+"/loki/api/v1/push", strings.NewReader(body))
  req.Header.Set("Content-Type", "application/json")
  req.Header.Set("X-Scope-OrgID", tenant)
  http.DefaultClient.Do(req)
}
```

**PHP**
```php
$tenant = $_SERVER['HTTP_X_TENANT_ID'] ?? null;
if ($tenant) {
  $ts = (int)(microtime(true) * 1e9);
  $json = json_encode([ 'streams' => [[
    'stream' => ['service' => 'my-api', 'env' => 'dev'],
    'values' => [[strval($ts), 'hello from php']]
  ]]]);
  $ch = curl_init(getenv('LOKI_URL').'/loki/api/v1/push');
  curl_setopt_array($ch, [
    CURLOPT_HTTPHEADER => ['Content-Type: application/json', 'X-Scope-OrgID: '.$tenant],
    CURLOPT_POSTFIELDS => $json,
    CURLOPT_RETURNTRANSFER => true,
  ]);
  curl_exec($ch);
  curl_close($ch);
}
```

**–°–æ–≤–µ—Ç—ã –ø–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
- –¢—Ä–µ–±—É–π—Ç–µ numeric `X-Tenant-Id`, –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω/–¥–æ—Å—Ç—É–ø.
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏/–Ω–µ–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ ‚Äî –Ω–µ –ø—É—à—å—Ç–µ –≤ Loki (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª—É–∂–µ–±–Ω—ã–π tenant –¥–ª—è –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏).
- –î–æ–±–∞–≤–ª—è–π—Ç–µ –ª–µ–π–±–ª—ã `service`, `env`, `version`, —á—Ç–æ–±—ã —É–¥–æ–±–Ω–æ –∏—Å–∫–∞—Ç—å –ª–æ–≥–∏.

## üöÄ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ (—Ç–æ–ª—å–∫–æ Git Submodules)

> **–í–∞–∂–Ω–æ:** –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –î–û–õ–ñ–ù–´ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∫–∞–∫ Git submodules. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞–ø—Ä—è–º—É—é –≤ packages/* –∑–∞–ø—Ä–µ—â–µ–Ω–æ.

### –®–∞–≥ 1: –î–æ–±–∞–≤—å—Ç–µ —Å–µ—Ä–≤–∏—Å –∫–∞–∫ Git submodule

```bash
git submodule add git@github.com:org/your-service.git packages/your-service
git submodule update --init --recursive
```

### –®–∞–≥ 2: –î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É

```bash
# –ß–µ—Ä–µ–∑ make
make add-infra PATH=packages/your-service

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é —Å–∫—Ä–∏–ø—Ç–æ–º
./scripts/service-add-infra.sh packages/your-service
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. üîç –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ (Node.js, Go, Python, PHP)
2. üê≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Dockerfile
3. ‚ò∏Ô∏è –°–æ–∑–¥–∞–µ—Ç Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã (base + overlays)
4. ‚öôÔ∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
5. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏:**
```
–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å?
1) Dockerfile (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
2) Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã (k8s/)
3) –í—Å—ë –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–µ
4) –û—Ç–º–µ–Ω–∞

–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é [1-4]: 3
–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: Node.js –ø—Ä–æ–µ–∫—Ç
–ü–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è [–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 3000]: 8080
```

### –®–∞–≥ 3: –î–µ–ø–ª–æ–π

```bash
make tilt-up
```

Tilt –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç —Å–µ—Ä–≤–∏—Å—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ:
- `Dockerfile` –≤ –∫–æ—Ä–Ω–µ
- `k8s/overlays/dev/kustomization.yaml`

### –í–Ω–µ—à–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫ –≤–Ω–µ—à–Ω–∏–º —Ä–µ–ø–æ (–≤–Ω–µ packages/):

```bash
./scripts/service-add-infra.sh /path/to/external/repo
```
